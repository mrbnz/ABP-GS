<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activitats</title>
</head>
<body>
  <h1  style="text-align: center;">ACTIVITATS</h1>
  <div style="width:500px; text-align: center; margin: auto;">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Busca aquí..." 
      style="padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 5px;">
  </div>
<br>
  <div style="display: flex;justify-content: space-between; margin: 0 100px;">

    <div>
      <p>TIPUS D'ACTIVITATS</p>
      <select id="selectTipus" style="height: 50px;width: 200px;">
        <option selected></option>
        {% for tipus in llistaTipus %}
          <option value="{{tipus.id}}">{{tipus.nom}}</option>
        {% endfor %}
      </select>
    </div>


    <div class="filtres">
      <p>ESPAI</p>
      <select id="selectEspai" style="height: 50px;width: 200px;">
        <option selected></option>
        {% for espai in llistaEspai %}
          <option value="{{espai.id}}">{{espai.nom}}</option>
        {% endfor %}
      </select>
    </div>


    <div class="filtres">
      <p>RANG DE DATES</p>
      <span>Inici : </span> 
      <input id="data1" type="date">
      <span>Fi : </span> 
      <input id="data2" type="date">
    </div>

    <div>
      <p>SELECCIONA EL PREU</p>
      <span>De : </span>
      <input id="preu1" type="number" value="0">
      <span>Fins a : </span>
      <input id="preu2" type="number" value="0">
    </div>

    <!--<div>
      <p>PAGINACIÓ</p>
      <select  style="height: 50px;width: 200px;">
      <option selected></option>
      <option value="4">4 activitats / página</option>
      <option value="7">7 activitats / página</option>
      <option value="10">10 activitats / página</option>
    </select>
  </div>-->
  </div>
  <br>
  <div style="margin: auto; width: 500px;">
    <button id="filtrarButton"
      style="width:100%;height: 50px; padding: 10px; border: none; background-color: #ff0000; color: white; border-radius: 5px;">
      Buscar
    </button>
  </div>
  <br>
    <!-- Llistat d'activitats -->
<div class="container mt-4">
  {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
  {% endif %}
  {% if success %}
      <div class="alert alert-success">{{ success }}</div>
  {% endif %}
  {% if missatge %}
      <div class="alert alert-info">{{ missatge }}</div>
  {% endif %}
  {% if debug %}
      <div class="alert alert-secondary">{{ debug }}</div>
  {% endif %}

  
 
  <ul id="ulActivitats" class="list-group">
  </ul>
</div>
<!-- Fi del llistat d'activitats -->
<script>

  const $ = e => document.getElementById(e)
  $("filtrarButton").addEventListener("click",filterFunction)

  let activitats = [];
  let activitat = [];

  {% for activitat in activitatLlista %}
    {% for key,value in activitat %}
      activitat["{{key}}"] = "{{value}}"
    {% endfor %}
    activitats.push(activitat)
    activitat = []
  {% endfor %}


  let activitatsTipus = [];
  let activitatTipus = [];

  {% for activitatTipus in llistaActivitatTipus %}
    {% for key,value in activitatTipus %}
      activitatTipus["{{key}}"] = "{{value}}"
    {% endfor %}
    activitatsTipus.push(activitatTipus)
    activitatTipus = []
  {% endfor %}

//console.log(activitats);
//console.log(activitatsTipus);

  function filtraDades(llista) {
    return llista.filter(e => {
      return (
        $("selectEspai").value === "" ||
        $("selectEspai").value === e["id_espai"]
      )
      && (
        $("preu1").value == 0 && $("preu2").value == 0 ||
        parseFloat($("preu1").value) <= parseFloat(e["preu"]) && parseFloat($("preu2").value) >= parseFloat(e["preu"])
      )
      && (
        $("data1").value == "" && $("data2").value == "" ||
        new Date($("data1".value)) <= new Date(e["data"]) && new Date($("data2").value) >= new Date(e["data"])
      )
      && (
        $("searchInput").value == "" ||
        decodeHtml(e["nom"].toUpperCase()).includes($("searchInput").value.toUpperCase())
        )
        && (
        buscarTipusActivitat(e)
      )
    })
  }
  function filterFunction(){
    mostrarActivitats(filtraDades(activitats))
  }

  function mostrarActivitats(llistaActivitats){
    const ulActivitats =$("ulActivitats")
    ulActivitats.replaceChildren()
    if (llistaActivitats.length > 0) {
      llistaActivitats.forEach(activitat => {
        const li = document.createElement("li")
        li.className = "list-group-item d-flex justify-content-between align-items-center"
        li.onclick = () => {
            window.location.href = `activitat/${activitat.id}`
        };

        const div = document.createElement("div")

        // Crear el título.
        const h5 = document.createElement("h5")
        h5.className = "card-title"
        h5.innerHTML = (activitat.nom)
            

         // Crear la descripción.
        const p = document.createElement("p")
        p.className = "card-text"
        p.innerHTML = activitat.descripcio_breu
          
        // Agregar título y descripción al contenedor de texto.
        div.appendChild(h5)
        div.appendChild(p)

        // Agregar el contenedor de texto al LI.
        li.appendChild(div)

        // Agregar el LI al UL.
        ulActivitats.appendChild(li)
      });
    } 
    else {
      // Crear el elemento LI para mostrar que no hay actividades.
      const li = document.createElement("li")
      li.className = "list-group-item text-center"
      li.textContent = "No hi ha activitats disponibles."

      // Agregar el LI al UL.
      ulActivitats.appendChild(li)
    }
  }

  // Ho utilitzem ver descodificar alguns signes com per exemple l'apòstrof
  function decodeHtml(html) {
    var txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
}
function buscarTipusActivitat(e){
  let trobat = false
  activitatsTipus.forEach(actTip => {
    if($("selectTipus").value == ""){
      trobat=true
    }
    else if(actTip["id_activitat"] == e["id"] && actTip["id_tipus_activitat"]==$("selectTipus").value){
      trobat=true
    }
  });
   return trobat
}
  buscarTipusActivitat()
  filterFunction()
  
</script>
</body>
</html>